- name: Prereqs
  hosts: localhost
  become: yes
  gather_facts: false
  tasks:
    - name: Check if Incus is installed
      command: rpm -q incus
      register: incus_check
      ignore_errors: yes

    - name: Fail if Incus is not installed
      fail:
        msg: "Required package 'Incus' is not installed"
      when: incus_check.rc != 0

    - name: Add the Overlay module
      community.general.modprobe:
        name: overlay
        state: present

    - name: Add the Netfilter module
      community.general.modprobe:
        name: br_netfilter
        state: present

- name: Incus profile
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if profile already exists
      command: incus profile show k3s
      register: k3s_check
      failed_when: false
      changed_when: false

    - name: Create an Incus profile
      ansible.builtin.shell: incus profile create k3s < profile.yaml
      when: k3s_check.rc != 0

- name: Setup Incus containers
  hosts: localhost
  gather_facts: false

  vars:
    container_names:
      - alpha
      - beta
      - gamma

  tasks:
    - name: Check if container {{ item }} exists
      ansible.builtin.shell: |
        incus info {{ item }}
      loop: "{{ container_names }}"
      register: container_check
      failed_when: false
      changed_when: false

    - name: Create container if it doesn't exist
      ansible.builtin.shell: |
        incus launch images:ubuntu/24.04 {{ item.item }} \
        --profile default --profile k3s
      loop: "{{ container_check.results }}"
      when: item.rc != 0
      changed_when: true

