- name: Prereqs
  hosts: localhost
  become: yes
  tasks:
    - name: Check if Incus is installed
      command: rpm -q incus
      register: incus_check
      ignore_errors: yes

    - name: Fail if Incus is not installed
      fail:
        msg: "Required package 'Incus' is not installed"
      when: incus_check.rc != 0

    - name: Add the Overlay module
      community.general.modprobe:
        name: overlay
        state: present

    - name: Add the Netfilter module
      community.general.modprobe:
        name: br_netfilter
        state: present

- name: Incus profile
  hosts: localhost
  tasks:
    - name: Check if profile already exists
      command: incus profile show k3s
      register: k3s_check
      failed_when: false
      changed_when: false

    - name: Create an Incus profile
      ansible.builtin.shell: incus profile create k3s < profile.yaml
      when: k3s_check.rc != 0
